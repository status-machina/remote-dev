#!/bin/bash
set -euo pipefail

BRANCH=${1:?Usage: wt-new <branch-name>}

MAIN_WORKTREE=$(git worktree list --porcelain | head -1 | sed 's/worktree //')
# Preserve the work/ or personal/ subdirectory in the worktree path
RELATIVE_PATH=$(realpath --relative-to=/home/developer/projects "$MAIN_WORKTREE")
PARENT_DIR=$(dirname "$RELATIVE_PATH")
BASE_DIR=$(basename "$MAIN_WORKTREE")
TARGET="/home/developer/projects/${PARENT_DIR}/${BASE_DIR}--${BRANCH}"

git worktree add "$TARGET" -b "$BRANCH"

# Copy over gitignored config files that don't travel with worktrees
for f in .npmrc .env .envrc; do
    if [ -f "$MAIN_WORKTREE/$f" ]; then
        cp "$MAIN_WORKTREE/$f" "$TARGET/$f"
        echo "Copied $f from main worktree"
    fi
done

echo "Worktree created at: $TARGET"
